<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BoletaPro - Automatizaci칩n de Honorarios para Profesionales</title>

    <!-- Google Fonts: Manrope -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- SheetJS for Excel Reading -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --bg-dark: #121212;
            --surface-dark: #1a1a1a;
            --primary-green: #00B37E;
            --primary-green-hover: #00996A;
            --primary-amber: #f59e0b;
            --primary-red: #e53e3e;
            --border-dark: #2a2a2a;
            --text-primary: #f5f5f5;
            --text-secondary: #a0a0a0;
            --whatsapp-color: #25D366;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Manrope', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
        }

        /* Utility Classes */
        .bg-surface-dark {
            background-color: var(--surface-dark);
        }

        .border-dark {
            border-color: var(--border-dark);
        }

        .text-primary-green {
            color: var(--primary-green);
        }

        .bg-primary-green {
            background-color: var(--primary-green);
        }

        .bg-primary-green-hover:hover {
            background-color: var(--primary-green-hover);
        }

        .btn-loading {
            background-color: var(--primary-amber);
        }

        .btn-danger {
            background-color: var(--primary-red);
        }

        .btn-danger:hover {
            background-color: #c53030;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.7s ease-in-out forwards;
        }

        @keyframes pulse-soft {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        /* Buttons */
        .btn {
            transition: all 0.3s ease;
        }

        .btn-secondary {
            border: 1px solid var(--border-dark);
        }

        .btn-secondary:hover {
            background-color: var(--surface-dark);
            border-color: var(--text-secondary);
        }

        #logout-btn:hover {
            background-color: var(--primary-red) !important;
            border-color: var(--primary-red) !important;
        }

        /* Modals */
        .modal-container {
            transition: opacity 0.3s ease-in-out;
        }

        .modal-container>div {
            transition: transform 0.3s ease-in-out;
        }

        /* Spinner */
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--bg-dark);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Sidebar */
        .sidebar-link {
            transition: background-color 0.2s, color 0.2s;
        }

        .sidebar-link.active,
        .sidebar-link:hover {
            background-color: var(--surface-dark);
            color: var(--text-primary);
            border-left: 3px solid var(--primary-green);
        }

        /* WhatsApp Button */
        .whatsapp-float {
            position: fixed;
            width: 60px;
            height: 60px;
            bottom: 30px;
            right: 30px;
            background-color: var(--whatsapp-color);
            color: #FFF;
            border-radius: 50px;
            text-align: center;
            font-size: 30px;
            box-shadow: 2px 2px 3px #999;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            animation: pulse-soft 2s infinite;
        }

        .whatsapp-float:hover {
            background-color: #1ebe57;
            transform: scale(1.1);
        }

        /* Video Modal */
        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            /* 16:9 */
            height: 0;
            overflow: hidden;
            border-radius: 0.5rem;
            background: #000;
        }

        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }

        /* Wizard Stepper Styles */
        .wizard-step {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .wizard-step-circle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid var(--border-dark);
            background-color: var(--surface-dark);
            color: var(--text-secondary);
            z-index: 2;
            transition: all 0.3s ease;
        }

        .wizard-step.active .wizard-step-circle {
            border-color: var(--primary-green);
            color: var(--primary-green);
            box-shadow: 0 0 0 4px rgba(0, 179, 126, 0.1);
        }

        .wizard-step.completed .wizard-step-circle {
            background-color: var(--primary-green);
            border-color: var(--primary-green);
            color: white;
        }

        .wizard-step-label {
            margin-top: 8px;
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-align: center;
            transition: color 0.3s ease;
        }

        .wizard-step.active .wizard-step-label {
            color: var(--primary-green);
            font-weight: 600;
        }

        .wizard-step.completed .wizard-step-label {
            color: var(--text-primary);
        }

        .wizard-step-connector {
            position: absolute;
            top: 24px;
            left: 50%;
            width: 100%;
            height: 2px;
            background-color: var(--border-dark);
            z-index: 1;
            transition: background-color 0.3s ease;
        }

        .wizard-step.completed .wizard-step-connector {
            background-color: var(--primary-green);
        }

        /* Radio Card Styles */
        .radio-card {
            display: block;
            /* Asegurar comportamiento de bloque */
            width: 100%;
            position: relative;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 24px;
            background-color: rgba(255, 255, 255, 0.03);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .radio-card:hover {
            background-color: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .radio-card.selected {
            border-color: var(--primary-green);
            background-color: rgba(0, 179, 126, 0.08);
            /* Fondo m치s sutil */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            /* Sombra mejorada */
            transform: translateY(-2px);
            /* Peque침a elevaci칩n */
        }



        .radio-card-content {
            display: flex;
            align-items: start;
            gap: 16px;
            position: relative;
        }

        /* Radio indicator (c칤rculo) */
        .radio-card-content::before {
            content: '';
            flex-shrink: 0;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--border-dark);
            background-color: var(--bg-dark);
            transition: all 0.3s ease;
            margin-top: 2px;
        }

        .radio-card.selected .radio-card-content::before {
            border-color: #00a3e0;
            background-color: #00a3e0;
            box-shadow: inset 0 0 0 4px var(--surface-dark);
        }

        .radio-card input[type="radio"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }



        /* Drag and Drop Zone */
        .drop-zone {
            border: 2px dashed var(--border-dark);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background-color: var(--surface-dark);
        }

        .drop-zone:hover,
        .drop-zone.drag-over {
            border-color: var(--primary-green);
            background-color: rgba(0, 179, 126, 0.05);
        }

        .drop-zone.drag-over {
            transform: scale(1.02);
        }

        /* Step Content Animation */
        .wizard-content {
            animation: fadeInUp 0.4s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideInRight 0.3s ease-out;
        }

        .toast.success {
            background-color: var(--primary-green);
        }

        .toast.error {
            background-color: var(--primary-red);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body class="antialiased">

    <!-- ======== WHATSAPP FLOATING BUTTON ======== -->
    <a href="https://wa.me/56938859332" class="whatsapp-float" target="_blank" title="Contactar por WhatsApp">
        <svg xmlns="http://www.w3.org/2000/svg" width="35" height="35" fill="currentColor" viewBox="0 0 16 16">
            <path
                d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z" />
        </svg>
    </a>

    <!-- ======== LANDING PAGE SECTION ======== -->
    <main id="landing-page" class="w-full flex flex-col min-h-screen">
        <div class="flex-grow">
            <!-- Header -->
            <header class="sticky top-0 z-50 bg-black bg-opacity-80 backdrop-blur-lg border-b border-dark">
                <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                    <a href="#" class="text-2xl font-bold text-white flex items-center gap-2">
                        <svg class="w-8 h-8 text-primary-green" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                        Boleta<span class="text-primary-green">Pro</span>
                    </a>
                    <div class="hidden md:flex items-center space-x-8">
                        <a href="#features" class="text-gray-400 hover:text-white transition">Funcionalidades</a>
                        <a href="#pricing" class="text-gray-400 hover:text-white transition">Planes</a>
                        <a href="#contact" class="text-gray-400 hover:text-white transition">Contacto</a>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button id="login-btn"
                            class="btn btn-secondary text-white px-4 py-2 rounded-md font-semibold text-sm">Iniciar
                            Sesi칩n</button>
                        <button id="signup-btn"
                            class="btn bg-primary-green text-white px-4 py-2 rounded-md font-semibold text-sm bg-primary-green-hover">Crear
                            Cuenta</button>
                    </div>
                </nav>
            </header>

            <!-- Hero Section -->
            <section class="container mx-auto px-6 pt-24 pb-16 md:pt-32 md:pb-24 text-center">
                <div class="max-w-4xl mx-auto">
                    <h1 class="text-4xl md:text-6xl font-extrabold text-white leading-tight mb-6 fade-in">
                        Automatiza tus Boletas de Honorarios <span class="text-primary-green">Sin Estr칠s</span>
                    </h1>
                    <p class="text-lg md:text-xl text-gray-400 mb-10 fade-in max-w-2xl mx-auto">
                        La soluci칩n definitiva para profesionales independientes. Carga tu planilla y emite miles de
                        boletas ante el SII en segundos. Sin c칩digos complejos, solo resultados.
                    </p>
                    <div class="flex justify-center space-x-4 fade-in">
                        <a href="#pricing"
                            class="btn bg-primary-green text-white px-8 py-3 rounded-md font-bold text-lg bg-primary-green-hover transform hover:-translate-y-1 transition duration-300">Empezar
                            Gratis</a>
                        <a href="#features"
                            class="btn btn-secondary text-white px-8 py-3 rounded-md font-bold text-lg hover:bg-gray-800">C칩mo
                            Funciona</a>
                    </div>
                </div>
                <!-- Visual Element Instead of Code Block -->
                <div class="mt-16 fade-in relative max-w-4xl mx-auto">
                    <div class="absolute inset-0 bg-primary-green opacity-10 blur-3xl rounded-full"></div>
                    <div
                        class="relative bg-surface-dark border border-dark rounded-xl p-8 shadow-2xl flex flex-col md:flex-row items-center justify-around gap-8">
                        <div class="text-center md:text-left">
                            <h3 class="text-2xl font-bold text-white mb-2">1. Carga tu Excel</h3>
                            <p class="text-gray-400">Sube tus destinatarios en un archivo simple.</p>
                        </div>
                        <div class="hidden md:block text-gray-600">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                            </svg>
                        </div>
                        <div class="text-center md:text-left">
                            <h3 class="text-2xl font-bold text-white mb-2">2. Procesa</h3>
                            <p class="text-gray-400">Nuestra plataforma conecta con el SII autom치ticamente.</p>
                        </div>
                        <div class="hidden md:block text-gray-600">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                            </svg>
                        </div>
                        <div class="text-center md:text-left">
                            <h3 class="text-2xl font-bold text-primary-green mb-2">3. 춰Listo!</h3>
                            <p class="text-gray-400">Descarga tus boletas emitidas al instante.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Features Section -->
            <section id="features" class="py-20 bg-surface-dark">
                <div class="container mx-auto px-6 text-center">
                    <h2 class="text-3xl md:text-4xl font-bold text-white mb-4">Dise침ado para Profesionales</h2>
                    <p class="text-lg text-gray-400 max-w-3xl mx-auto mb-16">Olv칤date de procesos manuales lentos.
                        Enf칩cate en tu trabajo mientras nosotros gestionamos la burocracia.</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div
                            class="p-8 border border-dark rounded-lg bg-gray-900/30 hover:border-primary-green transition duration-300">
                            <div
                                class="text-primary-green mb-4 bg-gray-800 w-16 h-16 rounded-full flex items-center justify-center mx-auto">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <h3 class="text-xl font-bold text-white mb-2">Ahorra Horas de Trabajo</h3>
                            <p class="text-gray-400">Emite 10, 100 o 1000 boletas en el tiempo que te toma tomarte un
                                caf칠.</p>
                        </div>
                        <div
                            class="p-8 border border-dark rounded-lg bg-gray-900/30 hover:border-primary-green transition duration-300">
                            <div
                                class="text-primary-green mb-4 bg-gray-800 w-16 h-16 rounded-full flex items-center justify-center mx-auto">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <h3 class="text-xl font-bold text-white mb-2">Cero Errores</h3>
                            <p class="text-gray-400">Evita multas y problemas contables eliminando el error humano en la
                                digitaci칩n.</p>
                        </div>
                        <div
                            class="p-8 border border-dark rounded-lg bg-gray-900/30 hover:border-primary-green transition duration-300">
                            <div
                                class="text-primary-green mb-4 bg-gray-800 w-16 h-16 rounded-full flex items-center justify-center mx-auto">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                            </div>
                            <h3 class="text-xl font-bold text-white mb-2">R치pido y Seguro</h3>
                            <p class="text-gray-400">Tu informaci칩n y claves viajan encriptadas. Solo t칰 tienes el
                                control.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Pricing Section (UPDATED) -->
            <section id="pricing" class="py-20">
                <div class="container mx-auto px-6">
                    <div class="text-center mb-16">
                        <h2 class="text-3xl md:text-4xl font-bold text-white mb-4">Planes Flexibles</h2>
                        <p class="text-lg text-gray-400 max-w-2xl mx-auto">Elige el plan que se adapte al volumen de tu
                            negocio.</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 max-w-7xl mx-auto">

                        <!-- Plan Gratuito -->
                        <div
                            class="border border-dark rounded-xl p-6 flex flex-col bg-surface-dark hover:transform hover:-translate-y-2 transition duration-300">
                            <h3 class="text-xl font-bold text-gray-300 mb-2">Gratuito</h3>
                            <p class="text-gray-500 text-sm mb-4">Ideal para probar</p>
                            <p class="text-3xl font-extrabold text-white mb-6">$0<span
                                    class="text-sm font-normal text-gray-400">/mes</span></p>
                            <ul class="text-sm space-y-3 text-gray-300 mb-8 flex-grow">
                                <li class="flex items-center"><svg class="w-4 h-4 text-primary-green mr-2" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M5 13l4 4L19 7"></path>
                                    </svg>20 boletas/mes</li>
                                <li class="flex items-center"><svg class="w-4 h-4 text-primary-green mr-2" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M5 13l4 4L19 7"></path>
                                    </svg>Soporte b치sico</li>
                            </ul>
                            <button class="w-full btn btn-secondary text-white py-2 rounded-md font-bold text-sm"
                                onclick="document.getElementById('signup-btn').click()">Crear Cuenta</button>
                        </div>

                        <!-- Plan B치sico -->
                        <div
                            class="border border-primary-green rounded-xl p-6 flex flex-col bg-gray-900 relative shadow-lg shadow-green-900/20 transform md:-translate-y-2">
                            <div
                                class="absolute top-0 right-0 bg-primary-green text-white text-[10px] font-bold px-2 py-1 rounded-bl-lg rounded-tr-lg">
                                INICIAL</div>
                            <h3 class="text-xl font-bold text-white mb-2">B치sico</h3>
                            <p class="text-gray-400 text-sm mb-4">Peque침os independientes</p>
                            <p class="text-3xl font-extrabold text-white mb-6">$4.990<span
                                    class="text-sm font-normal text-gray-400">/mes</span></p>
                            <ul class="text-sm space-y-3 text-gray-300 mb-8 flex-grow">
                                <li class="flex items-center"><svg class="w-4 h-4 text-primary-green mr-2" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M5 13l4 4L19 7"></path>
                                    </svg>100 boletas/mes</li>
                                <li class="flex items-center"><svg class="w-4 h-4 text-primary-green mr-2" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M5 13l4 4L19 7"></path>
                                    </svg>Soporte por email</li>
                                <li class="flex items-center"><svg class="w-4 h-4 text-primary-green mr-2" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M5 13l4 4L19 7"></path>
                                    </svg>Historial de 3 meses</li>
                            </ul>
                            <a href="https://wa.me/56938859332?text=Hola,%20quiero%20el%20Plan%20B치sico" target="_blank"
                                class="w-full btn bg-primary-green text-white py-2 rounded-md font-bold text-sm bg-primary-green-hover text-center">Contratar</a>
                        </div>

                        <!-- Plan Avanzado -->
                        <div
                            class="border border-dark rounded-xl p-6 flex flex-col bg-surface-dark hover:transform hover:-translate-y-2 transition duration-300">
                            <h3 class="text-xl font-bold text-white mb-2">Avanzado</h3>
                            <p class="text-gray-400 text-sm mb-4">Consultoras y PyMEs</p>
                            <p class="text-3xl font-extrabold text-white mb-6">$14.990<span
                                    class="text-sm font-normal text-gray-400">/mes</span></p>
                            <ul class="text-sm space-y-3 text-gray-300 mb-8 flex-grow">
                                <li class="flex items-center"><svg class="w-4 h-4 text-primary-green mr-2" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M5 13l4 4L19 7"></path>
                                    </svg>500 boletas/mes</li>
                                <li class="flex items-center"><svg class="w-4 h-4 text-primary-green mr-2" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M5 13l4 4L19 7"></path>
                                    </svg>Soporte Prioritario</li>
                                <li class="flex items-center"><svg class="w-4 h-4 text-primary-green mr-2" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M5 13l4 4L19 7"></path>
                                    </svg>Historial de 1 a침o</li>
                            </ul>
                            <a href="https://wa.me/56938859332?text=Hola,%20quiero%20el%20Plan%20Avanzado"
                                target="_blank"
                                class="w-full btn btn-secondary text-white py-2 rounded-md font-bold text-sm text-center">Contratar</a>
                        </div>

                        <!-- Plan Premium -->
                        <div
                            class="border border-dark rounded-xl p-6 flex flex-col bg-surface-dark hover:transform hover:-translate-y-2 transition duration-300">
                            <h3 class="text-xl font-bold text-primary-amber mb-2">Premium</h3>
                            <p class="text-gray-400 text-sm mb-4">Alto volumen</p>
                            <p class="text-3xl font-extrabold text-white mb-6">$39.990<span
                                    class="text-sm font-normal text-gray-400">/mes</span></p>
                            <ul class="text-sm space-y-3 text-gray-300 mb-8 flex-grow">
                                <li class="flex items-center"><svg class="w-4 h-4 text-primary-amber mr-2" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M5 13l4 4L19 7"></path>
                                    </svg>2000 boletas/mes</li>
                                <li class="flex items-center"><svg class="w-4 h-4 text-primary-amber mr-2" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M5 13l4 4L19 7"></path>
                                    </svg>Atenci칩n WhatsApp Directa</li>
                                <li class="flex items-center"><svg class="w-4 h-4 text-primary-amber mr-2" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M5 13l4 4L19 7"></path>
                                    </svg>Historial Ilimitado</li>
                            </ul>
                            <a href="https://wa.me/56938859332?text=Hola,%20quiero%20el%20Plan%20Premium"
                                target="_blank"
                                class="w-full btn btn-secondary text-white py-2 rounded-md font-bold text-sm text-center border-primary-amber text-primary-amber hover:bg-amber-900/20">Contratar</a>
                        </div>

                    </div>
                </div>
            </section>

            <section id="contact" class="py-20 bg-surface-dark">
                <div class="container mx-auto px-6 text-center">
                    <h2 class="text-3xl md:text-4xl font-bold text-white mb-4">Cont치ctanos</h2>
                    <p class="text-lg text-gray-400 max-w-2xl mx-auto mb-12">쯊ienes dudas sobre los planes? Hablemos.
                    </p>
                    <form class="max-w-xl mx-auto text-left">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label for="contact-name"
                                    class="block text-sm font-medium text-gray-400 mb-2">Nombre</label>
                                <input type="text" id="contact-name" required
                                    class="w-full p-3 bg-gray-900 border border-dark rounded-md text-white focus:outline-none focus:ring-2 focus:ring-primary-green">
                            </div>
                            <div>
                                <label for="contact-email"
                                    class="block text-sm font-medium text-gray-400 mb-2">Email</label>
                                <input type="email" id="contact-email" required
                                    class="w-full p-3 bg-gray-900 border border-dark rounded-md text-white focus:outline-none focus:ring-2 focus:ring-primary-green">
                            </div>
                        </div>
                        <div class="mb-6">
                            <label for="contact-message"
                                class="block text-sm font-medium text-gray-400 mb-2">Mensaje</label>
                            <textarea id="contact-message" rows="4" required
                                class="w-full p-3 bg-gray-900 border border-dark rounded-md text-white focus:outline-none focus:ring-2 focus:ring-primary-green"></textarea>
                        </div>
                        <div class="text-center">
                            <button type="submit"
                                class="btn bg-primary-green text-white px-8 py-3 rounded-md font-bold text-lg bg-primary-green-hover">Enviar
                                Mensaje</button>
                        </div>
                    </form>
                </div>
            </section>
        </div>
        <!-- Footer -->
        <footer class="bg-surface-dark border-t border-dark">
            <div class="container mx-auto px-6 py-8 text-center text-gray-400">
                <p>&copy; 2025 BoletaPro. Todos los derechos reservados.</p>
            </div>
        </footer>
    </main>

    <!-- ======== LOGIN/SIGNUP SECTION ======== -->
    <section id="auth-section"
        class="modal-container fixed inset-0 bg-black bg-opacity-80 z-50 flex justify-center items-center p-4 opacity-0 pointer-events-none">
        <div id="auth-modal"
            class="bg-surface-dark w-full max-w-md p-8 rounded-lg border border-dark shadow-2xl transform scale-95">
            <!-- Login View -->
            <div id="login-view">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-white">Iniciar Sesi칩n</h2>
                    <button id="close-auth-modal-btn" class="text-gray-500 hover:text-white text-2xl">&times;</button>
                </div>
                <p class="text-gray-400 mb-6">Accede a tu plataforma para emitir boletas.</p>
                <form id="login-form">
                    <div id="login-error-message" class="hidden p-3 mb-4 text-sm text-red-400 bg-red-900/50 rounded-md">
                    </div>
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-medium text-gray-400 mb-2">Email</label>
                        <input type="email" id="login-email" required
                            class="w-full p-3 bg-gray-900 border border-dark rounded-md text-white focus:outline-none focus:ring-2 focus:ring-primary-green">
                    </div>
                    <div class="mb-6">
                        <label for="login-password"
                            class="block text-sm font-medium text-gray-400 mb-2">Contrase침a</label>
                        <input type="password" id="login-password" required
                            class="w-full p-3 bg-gray-900 border border-dark rounded-md text-white focus:outline-none focus:ring-2 focus:ring-primary-green">
                    </div>
                    <button type="submit"
                        class="w-full btn bg-primary-green text-white py-3 rounded-md font-bold bg-primary-green-hover flex justify-center items-center">Ingresar</button>
                </form>
                <p class="text-center text-sm text-gray-400 mt-6">쯅o tienes cuenta? <button id="show-signup-view"
                        class="font-semibold text-primary-green hover:underline">Reg칤strate</button></p>
            </div>

            <!-- Signup View (With T&C) -->
            <div id="signup-view" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-white">Crear Cuenta</h2>
                    <button class="close-auth-modal-btn text-gray-500 hover:text-white text-2xl">&times;</button>
                </div>
                <p class="text-gray-400 mb-6">Comienza con el Plan Gratuito.</p>
                <form id="signup-form">
                    <div id="signup-error-message"
                        class="hidden p-3 mb-4 text-sm text-red-400 bg-red-900/50 rounded-md"></div>
                    <div id="signup-success-message"
                        class="hidden p-3 mb-4 text-sm text-green-400 bg-green-900/50 rounded-md"></div>
                    <div class="mb-4">
                        <label for="signup-email" class="block text-sm font-medium text-gray-400 mb-2">Email</label>
                        <input type="email" id="signup-email" required
                            class="w-full p-3 bg-gray-900 border border-dark rounded-md text-white focus:outline-none focus:ring-2 focus:ring-primary-green">
                    </div>
                    <div class="mb-4">
                        <label for="signup-password"
                            class="block text-sm font-medium text-gray-400 mb-2">Contrase침a</label>
                        <input type="password" id="signup-password" required
                            class="w-full p-3 bg-gray-900 border border-dark rounded-md text-white focus:outline-none focus:ring-2 focus:ring-primary-green">
                    </div>
                    <div class="mb-4">
                        <label for="signup-confirm-password"
                            class="block text-sm font-medium text-gray-400 mb-2">Confirmar Contrase침a</label>
                        <input type="password" id="signup-confirm-password" required
                            class="w-full p-3 bg-gray-900 border border-dark rounded-md text-white focus:outline-none focus:ring-2 focus:ring-primary-green">
                    </div>
                    <!-- T&C Checkbox -->
                    <div class="mb-6 flex items-start">
                        <div class="flex items-center h-5">
                            <input id="terms" name="terms" type="checkbox" required
                                class="w-4 h-4 bg-gray-900 border border-dark rounded focus:ring-primary-green text-primary-green">
                        </div>
                        <div class="ml-3 text-sm">
                            <label for="terms" class="font-medium text-gray-400">Acepto los <a href="#"
                                    class="text-primary-green hover:underline">T칠rminos y Condiciones</a> de
                                uso.</label>
                        </div>
                    </div>

                    <button type="submit"
                        class="w-full btn bg-primary-green text-white py-3 rounded-md font-bold bg-primary-green-hover flex justify-center items-center">Crear
                        Cuenta</button>
                </form>
                <p class="text-center text-sm text-gray-400 mt-6">쯏a tienes cuenta? <button id="show-login-view"
                        class="font-semibold text-primary-green hover:underline">Inicia Sesi칩n</button></p>
            </div>
        </div>
    </section>

    <!-- ======== TUTORIAL MODAL (NEW) ======== -->
    <section id="tutorial-modal-section"
        class="modal-container fixed inset-0 bg-black bg-opacity-90 z-[60] flex justify-center items-center p-4 opacity-0 pointer-events-none">
        <div id="tutorial-modal"
            class="bg-surface-dark w-full max-w-4xl p-6 rounded-lg border border-dark shadow-2xl transform scale-95 flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">游꿉 Aprende a usar BoletaPro en 2 minutos</h2>
                <button id="close-tutorial-modal-btn" class="text-gray-500 hover:text-white text-3xl">&times;</button>
            </div>
            <div class="video-container mb-6 bg-black rounded-lg border border-dark">
                <!-- Placeholder for Video Tutorial -->
                <div class="absolute inset-0 flex flex-col items-center justify-center text-gray-500">
                    <svg class="w-16 h-16 mb-4 text-primary-green opacity-80" fill="currentColor" viewBox="0 0 16 16">
                        <path
                            d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM6.79 5.093A.5.5 0 0 0 6 5.5v5a.5.5 0 0 0 .79.407l3.5-2.5a.5.5 0 0 0 0-.814l-3.5-2.5z" />
                    </svg>
                    <p class="text-lg">Aqu칤 se reproducir치 el Video Tutorial</p>
                    <p class="text-sm text-gray-600">(YouTube Embed)</p>
                </div>
                <!-- <iframe src="https://www.youtube.com/embed/TU_VIDEO_ID" title="Tutorial BoletaPro" allowfullscreen></iframe> -->
            </div>
            <div class="flex justify-end">
                <button id="finish-tutorial-btn"
                    class="btn bg-primary-green text-white px-6 py-2 rounded-md font-bold bg-primary-green-hover">춰Entendido,
                    vamos!</button>
            </div>
        </div>
    </section>


    <!-- ======== DASHBOARD SECTION ======== -->
    <main id="dashboard-section" class="hidden w-full min-h-screen bg-black">
        <div class="flex h-screen">
            <!-- Sidebar -->
            <aside id="sidebar"
                class="bg-surface-dark w-64 flex-shrink-0 border-r border-dark p-4 flex flex-col fixed lg:relative h-full lg:h-auto -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out z-40">
                <a href="#" class="text-2xl font-bold text-white mb-8 block flex items-center gap-2">
                    <svg class="w-6 h-6 text-primary-green" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    Boleta<span class="text-primary-green">Pro</span>
                </a>
                <nav class="flex flex-col space-y-2">
                    <a href="#dashboard" data-view="dashboard-view"
                        class="sidebar-link active flex items-center p-3 rounded-md text-gray-400 font-semibold">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                            </path>
                        </svg>
                        Resumen
                    </a>
                    <a href="#api-explorer" data-view="api-explorer-view"
                        class="sidebar-link flex items-center p-3 rounded-md text-gray-400 font-semibold">
                        <!-- ICONO ACTUALIZADO: Documento/Factura -->
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                        Emitir Boletas
                    </a>
                    <a href="#settings" data-view="settings-view"
                        class="sidebar-link flex items-center p-3 rounded-md text-gray-400 font-semibold">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0 3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                            </path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Configuraci칩n
                    </a>
                </nav>
                <div class="mt-auto">
                    <button id="logout-btn"
                        class="w-full btn btn-secondary text-white px-4 py-2 rounded-md font-semibold">Cerrar
                        Sesi칩n</button>
                </div>
            </aside>

            <!-- Main Content -->
            <div class="flex-1 flex flex-col">
                <!-- Top bar -->
                <header class="bg-surface-dark border-b border-dark flex justify-between items-center p-4 lg:hidden">
                    <button id="menu-toggle-btn" class="text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    <div class="text-gray-400">Hola, <span id="user-email-display"></span></div>
                </header>

                <div class="flex-1 overflow-y-auto p-6 md:p-8">

                    <!-- Dashboard View -->
                    <div id="dashboard-view" class="dashboard-view">
                        <div class="flex justify-between items-end mb-8">
                            <div>
                                <h2 class="text-4xl font-bold text-white">Panel de Control</h2>
                                <p class="text-gray-400 mt-2">Bienvenido de vuelta. Aqu칤 est치 el resumen de tus
                                    emisiones.</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                            <div class="bg-surface-dark p-6 rounded-lg border border-dark">
                                <h3 class="text-lg font-semibold text-gray-400 mb-4">L칤mite Total Plan</h3>
                                <div id="consumption-container" class="space-y-4">
                                    <!-- Datos de consumo se cargar치n aqu칤 -->
                                </div>
                            </div>

                            <!-- NUEVA TARJETA BHE -->
                            <div
                                class="bg-surface-dark p-6 rounded-lg border border-dark flex flex-col justify-between">
                                <h3 class="text-lg font-semibold text-gray-400 mb-2">Boletas Propias (BHE)</h3>
                                <div class="mt-auto">
                                    <span id="bhe-count-display" class="text-4xl font-bold text-primary-green">0</span>
                                    <span class="text-gray-500 text-sm ml-2">este mes</span>
                                </div>
                                <div class="mt-2 text-xs text-gray-500">Consumo acumulado actual</div>
                            </div>

                            <div
                                class="bg-surface-dark p-6 rounded-lg border border-dark flex flex-col justify-center items-center text-center">
                                <h3 class="text-lg font-semibold text-white mb-2">쯅ecesitas ayuda?</h3>
                                <p class="text-gray-400 text-sm mb-4">Contacta a nuestro soporte especializado.</p>
                                <a href="https://wa.me/56938859332" target="_blank"
                                    class="btn bg-primary-green text-white px-6 py-2 rounded-md font-semibold bg-primary-green-hover">
                                    Chat Soporte WhatsApp
                                </a>
                            </div>
                        </div>

                        <h3 class="text-2xl font-bold text-white mb-4">Historial de Boletas</h3>
                        <div class="bg-surface-dark rounded-lg border border-dark overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead>
                                        <tr class="border-b border-dark">
                                            <th class="p-4 font-semibold text-gray-400"
                                                title="ID de la tarea en Google Cloud">ID Tarea / Proceso</th>
                                            <th class="p-4 font-semibold text-gray-400">Fecha</th>
                                            <th class="p-4 font-semibold text-gray-400">Tipo</th>
                                            <th class="p-4 font-semibold text-gray-400">Cantidad</th>
                                            <th class="p-4 font-semibold text-gray-400">Estado</th>
                                            <th class="p-4 font-semibold text-gray-400">Archivo</th>
                                            <th class="p-4 font-semibold text-gray-400">Detalles</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usage-history-body">
                                        <!-- Filas del historial se cargar치n aqu칤 -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="pagination-controls"
                                class="flex items-center justify-between p-4 border-t border-dark">
                                <div class="flex items-center space-x-2">
                                    <label for="page-size-select" class="text-sm text-gray-400">Mostrar:</label>
                                    <select id="page-size-select"
                                        class="bg-gray-900 border border-dark rounded-md p-1 text-sm text-white focus:outline-none focus:ring-2 focus:ring-primary-green">
                                        <option value="5">5</option>
                                        <option value="10">10</option>
                                        <option value="20">20</option>
                                    </select>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <button id="prev-page-btn"
                                        class="pagination-btn btn btn-secondary text-white px-4 py-2 rounded-md font-semibold text-sm">Anterior</button>
                                    <span id="page-indicator" class="text-sm text-gray-400"></span>
                                    <button id="next-page-btn"
                                        class="pagination-btn btn btn-secondary text-white px-4 py-2 rounded-md font-semibold text-sm">Siguiente</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Emission View (Wizard de 4 Pasos) -->
                    <div id="api-explorer-view" class="dashboard-view hidden">
                        <h2 class="text-4xl font-bold text-white mb-2">Asistente de Emisi칩n de Boletas</h2>
                        <p class="text-gray-400 mb-8">Sigue los pasos para emitir tus boletas de honorarios de forma
                            masiva.</p>

                        <!-- Stepper (Indicador de Progreso) -->
                        <div class="mb-8">
                            <div class="flex items-center justify-between max-w-4xl mx-auto px-4">
                                <!-- Step 1 -->
                                <div class="wizard-step active" data-step="1">
                                    <div class="wizard-step-circle">1</div>
                                    <div class="wizard-step-label">Tipo de boleta</div>
                                    <div class="wizard-step-connector"></div>
                                </div>
                                <!-- Step 2 -->
                                <div class="wizard-step" data-step="2">
                                    <div class="wizard-step-circle">2</div>
                                    <div class="wizard-step-label">Carga de Datos</div>
                                    <div class="wizard-step-connector"></div>
                                </div>
                                <!-- Step 3 -->
                                <div class="wizard-step" data-step="3">
                                    <div class="wizard-step-circle">3</div>
                                    <div class="wizard-step-label">Previsualizar y Validar</div>
                                    <div class="wizard-step-connector"></div>
                                </div>
                                <!-- Step 4 -->
                                <div class="wizard-step" data-step="4">
                                    <div class="wizard-step-circle">4</div>
                                    <div class="wizard-step-label">Emitir</div>
                                </div>
                            </div>
                        </div>

                        <!-- Wizard Content Container -->
                        <div class="bg-surface-dark rounded-xl border border-dark p-8 max-w-4xl mx-auto">

                            <!-- PASO 1: Tipo de Boleta -->
                            <div id="wizard-step-1" class="wizard-content">
                                <h3 class="text-2xl font-bold text-white mb-6">Selecciona el Tipo de Boleta</h3>
                                <div class="space-y-8">
                                    <!-- Opci칩n BHE -->
                                    <label class="radio-card" for="tipo-bhe">
                                        <input type="radio" name="tipo-boleta" id="tipo-bhe" value="bhe">
                                        <div class="radio-card-content">
                                            <div class="text-primary-green">
                                                <svg class="w-8 h-8" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z">
                                                    </path>
                                                </svg>
                                            </div>
                                            <div>
                                                <h4 class="text-lg font-bold text-white mb-1">Boleta de Honorarios
                                                    Electr칩nica (BHE)</h4>
                                                <p class="text-sm text-gray-400">Emisi칩n de boletas por servicios
                                                    personales</p>
                                            </div>
                                        </div>
                                    </label>

                                    <!-- Opci칩n BHET -->
                                    <label class="radio-card hidden" for="tipo-bhet">
                                        <input type="radio" name="tipo-boleta" id="tipo-bhet" value="bht">
                                        <div class="radio-card-content">
                                            <div class="text-primary-green">
                                                <svg class="w-8 h-8" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                                                    </path>
                                                </svg>
                                            </div>
                                            <div>
                                                <h4 class="text-lg font-bold text-white mb-1">Boleta de Honorarios de
                                                    Terceros (BHET)</h4>
                                                <p class="text-sm text-gray-400">Emisi칩n de boletas por cuenta de
                                                    terceros</p>
                                            </div>
                                        </div>
                                    </label>
                                </div>

                                <div class="flex justify-end mt-8">
                                    <button id="btn-step1-next" disabled
                                        class="btn bg-gray-600 text-white px-8 py-3 rounded-md font-bold cursor-not-allowed">
                                        Siguiente
                                    </button>
                                </div>
                            </div>

                            <!-- PASO 2: Carga de Archivo -->
                            <div id="wizard-step-2" class="wizard-content hidden">
                                <h3 class="text-2xl font-bold text-white mb-6">Cargar Archivo</h3>

                                <!-- Plantilla de descarga (solo para BHE) -->
                                <div id="plantilla-bhe-info"
                                    class="hidden mb-6 bg-gray-900/50 p-4 rounded border border-dark">
                                    <div class="flex justify-between items-center mb-2">
                                        <h4 class="text-sm font-medium text-white">Plantilla Requerida</h4>
                                        <a href="/bhe/plantilla-excel" target="_blank"
                                            class="text-xs text-primary-green hover:underline flex items-center">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4">
                                                </path>
                                            </svg>
                                            Descargar Excel
                                        </a>
                                    </div>
                                    <p class="text-xs text-gray-500">Usa la plantilla oficial para evitar errores de
                                        formato.</p>
                                </div>

                                <!-- Drag & Drop Zone -->
                                <div id="drop-zone" class="drop-zone">
                                    <input type="file" id="file-input" accept=".csv,.xlsx,.xls" class="hidden">
                                    <svg class="w-16 h-16 mx-auto mb-4 text-gray-600" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                                        </path>
                                    </svg>
                                    <p class="text-lg text-gray-400 mb-2">Arrastra tu Excel aqu칤</p>
                                    <p class="text-sm text-gray-600 mb-4">o haz clic para seleccionar</p>
                                    <p class="text-xs text-gray-700">Formatos permitidos: .csv, .xlsx | M치ximo 5MB</p>
                                </div>

                                <!-- File Info (despu칠s de cargar) -->
                                <div id="file-info"
                                    class="hidden mt-4 p-4 bg-green-900/20 border border-green-800 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <svg class="w-6 h-6 text-primary-green" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            <div>
                                                <p class="text-sm font-semibold text-primary-green" id="file-name"></p>
                                                <p class="text-xs text-gray-500" id="file-size"></p>
                                            </div>
                                        </div>
                                        <button id="btn-remove-file" class="text-red-400 hover:text-red-300">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>

                                <div class="flex justify-between mt-8">
                                    <button id="btn-step2-back"
                                        class="btn btn-secondary text-white px-8 py-3 rounded-md font-bold">
                                        Atr치s
                                    </button>
                                    <button id="btn-step2-next" disabled
                                        class="btn bg-gray-600 text-white px-8 py-3 rounded-md font-bold cursor-not-allowed">
                                        Siguiente
                                    </button>
                                </div>
                            </div>

                            <!-- PASO 3: Previsualizaci칩n y Validaci칩n -->
                            <div id="wizard-step-3" class="wizard-content hidden">
                                <h3 class="text-2xl font-bold text-white mb-6">Previsualizar y Validar Datos</h3>

                                <!-- Validation Status -->
                                <div id="validation-status" class="mb-6 hidden">
                                    <!-- Se llenar치 din치micamente -->
                                </div>

                                <!-- Preview Table -->
                                <div class="overflow-x-auto mb-6 border border-dark rounded-lg">
                                    <table id="preview-table" class="w-full text-left text-sm">
                                        <thead class="bg-gray-900/50">
                                            <!-- Headers se llenar치n din치micamente -->
                                        </thead>
                                        <tbody class="text-gray-300">
                                            <!-- Rows se llenar치n din치micamente -->
                                        </tbody>
                                    </table>
                                </div>

                                <p class="text-xs text-gray-600 mb-6">Mostrando las primeras 5 filas del archivo
                                    cargado.</p>

                                <div class="flex justify-between">
                                    <button id="btn-step3-back"
                                        class="btn btn-secondary text-white px-8 py-3 rounded-md font-bold">
                                        Atr치s
                                    </button>
                                    <button id="btn-step3-next" disabled
                                        class="btn bg-gray-600 text-white px-8 py-3 rounded-md font-bold cursor-not-allowed">
                                        Confirmar
                                    </button>
                                </div>
                            </div>

                            <!-- PASO 4: Emisi칩n Final -->
                            <div id="wizard-step-4" class="wizard-content hidden">
                                <h3 class="text-2xl font-bold text-white mb-6">Credenciales y Emisi칩n</h3>

                                <form id="wizard-final-form" class="space-y-6">
                                    <div>
                                        <label for="wizard-rut" class="block text-sm font-medium text-gray-400 mb-2">RUT
                                            Emisor</label>
                                        <input type="text" id="wizard-rut" name="rut" placeholder="11.111.111-1"
                                            required
                                            class="w-full p-3 bg-gray-900 border border-dark rounded-md text-white focus:outline-none focus:ring-2 focus:ring-primary-green">
                                    </div>

                                    <div>
                                        <label for="wizard-clave"
                                            class="block text-sm font-medium text-gray-400 mb-2">Clave SII</label>
                                        <input type="password" id="wizard-clave" name="clave" placeholder="뮉뮉뮉뮉뮉뮉뮉"
                                            required
                                            class="w-full p-3 bg-gray-900 border border-dark rounded-md text-white focus:outline-none focus:ring-2 focus:ring-primary-green">
                                    </div>

                                    <!-- Campo adicional para BHE -->
                                    <div id="wizard-tipo-retencion-container" class="hidden">
                                        <label for="wizard-tipo-retencion"
                                            class="block text-sm font-medium text-gray-400 mb-2">Tipo de
                                            Retenci칩n</label>
                                        <select id="wizard-tipo-retencion" name="tipo_retencion"
                                            class="w-full p-3 bg-gray-900 border border-dark rounded-md text-white focus:outline-none focus:ring-2 focus:ring-primary-green">
                                            <option value="Receptor" selected>Retiene el Receptor (Empresa)</option>
                                            <option value="Emisor">Retiene el Emisor (Yo)</option>
                                        </select>
                                    </div>

                                    <div class="flex justify-between items-center pt-4">
                                        <button type="button" id="btn-step4-back"
                                            class="btn btn-secondary text-white px-8 py-3 rounded-md font-bold">
                                            Atr치s
                                        </button>
                                        <button type="submit" id="btn-emit-now"
                                            class="btn bg-primary-green text-white px-12 py-3 rounded-md font-bold text-lg bg-primary-green-hover shadow-lg shadow-green-900/50">
                                            EMITIR AHORA
                                        </button>
                                    </div>
                                </form>

                                <!-- Resultado de la emisi칩n -->
                                <div id="emission-result" class="hidden mt-8 p-6 rounded-lg border">
                                    <!-- Se llenar치 din치micamente -->
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- Settings View -->
                    <div id="settings-view" class="dashboard-view hidden">
                        <h2 class="text-4xl font-bold text-white mb-8">Configuraci칩n</h2>
                        <div class="space-y-8">
                            <div class="bg-surface-dark p-6 rounded-lg border border-dark">
                                <h3 class="text-xl font-bold text-white mb-4">Mi Perfil</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label for="profile-email"
                                            class="block text-sm font-medium text-gray-400 mb-1">Email
                                            Registrado</label>
                                        <input type="email" id="profile-email" value="" disabled
                                            class="w-full md:w-1/2 p-2 bg-gray-800 border-dark rounded-md text-gray-500 cursor-not-allowed">
                                    </div>
                                    <!-- "Guardar Cambios" BUTTON REMOVED -->
                                </div>
                            </div>

                            <!-- API KEY SECTION REMOVED FOR USER PRIVACY -->

                            <div class="bg-surface-dark p-6 rounded-lg border border-dark">
                                <h3 class="text-xl font-bold text-white mb-4">Plan y Facturaci칩n</h3>
                                <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                                    <div class="mb-4 md:mb-0">
                                        <p class="text-gray-400">Plan actual: <span id="current-plan-name"
                                                class="font-bold text-primary-green">Cargando...</span></p>
                                        <p class="text-gray-400 text-sm mt-1">Aumenta tu l칤mite de emisiones contratando
                                            un plan superior.</p>
                                    </div>
                                    <a href="https://wa.me/56938859332?text=Hola,%20quisiera%20mejorar%20mi%20plan%20en%20BoletaPro"
                                        target="_blank"
                                        class="btn bg-primary-green text-white px-5 py-2 rounded-md font-semibold bg-primary-green-hover flex items-center gap-2">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 16 16">
                                            <path
                                                d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326z" />
                                        </svg>
                                        Contactar para Upgrade
                                    </a>
                                </div>
                            </div>

                            <div class="bg-surface-dark p-6 rounded-lg border border-red-500/30">
                                <h3 class="text-xl font-bold text-red-500 mb-2">Zona de Peligro</h3>
                                <p class="text-gray-400 mb-4 text-sm">Eliminar tu cuenta borrar치 todo tu historial de
                                    boletas emitidas.</p>
                                <button id="delete-account-btn"
                                    class="btn btn-danger text-white px-5 py-2 rounded-md font-semibold text-sm">Eliminar
                                    mi Cuenta</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer for Dashboard -->
                <footer class="bg-surface-dark border-t border-dark mt-auto">
                    <div class="container mx-auto px-6 py-4 text-center text-gray-400 text-sm">
                        <p>&copy; 2025 BoletaPro.</p>
                    </div>
                </footer>
            </div>
        </div>
    </main>

    <!-- ======== MODALS ======== -->
    <section id="error-modal-section"
        class="modal-container fixed inset-0 bg-black bg-opacity-80 z-50 flex justify-center items-center p-4 opacity-0 pointer-events-none">
        <div id="error-modal"
            class="bg-surface-dark w-full max-w-lg p-8 rounded-lg border border-dark shadow-2xl transform scale-95">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">Detalle del Error</h2><button id="close-error-modal"
                    class="text-gray-500 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="error-analysis-content-modal" class="text-gray-300 space-y-4 max-h-96 overflow-y-auto"></div>
        </div>
    </section>

    <section id="delete-confirm-modal-section"
        class="modal-container fixed inset-0 bg-black bg-opacity-80 z-50 flex justify-center items-center p-4 opacity-0 pointer-events-none">
        <div id="delete-confirm-modal"
            class="bg-surface-dark w-full max-w-lg p-8 rounded-lg border border-dark shadow-2xl transform scale-95">
            <h2 class="text-2xl font-bold text-red-500 mb-4">쮼st치s seguro?</h2>
            <p class="text-gray-400 mb-6">Esta acci칩n es irreversible.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-delete-btn"
                    class="btn btn-secondary text-white px-5 py-2 rounded-md font-semibold">Cancelar</button>
                <button id="confirm-delete-btn" class="btn btn-danger text-white px-5 py-2 rounded-md font-semibold">S칤,
                    eliminar</button>
            </div>
        </div>
    </section>

    <!-- Placeholder for JS env -->
    <script src="env.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Supabase Init ---
            const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            let isDashboardInitialized = false;
            let loadDashboardData = null;

            // --- DOM Elements ---
            const landingPage = document.getElementById('landing-page');
            const authSection = document.getElementById('auth-section');
            const dashboardSection = document.getElementById('dashboard-section');
            const loginBtn = document.getElementById('login-btn');
            const signupBtn = document.getElementById('signup-btn');
            const closeAuthModalBtn = document.getElementById('close-auth-modal-btn');
            const loginView = document.getElementById('login-view');
            const signupView = document.getElementById('signup-view');
            const showSignupViewBtn = document.getElementById('show-signup-view');
            const showLoginViewBtn = document.getElementById('show-login-view');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');

            // Tutorial Modal Elements
            const tutorialModalSection = document.getElementById('tutorial-modal-section');
            const closeTutorialModalBtn = document.getElementById('close-tutorial-modal-btn');
            const finishTutorialBtn = document.getElementById('finish-tutorial-btn');

            // --- UI Helper Functions ---
            const showAuthModal = (view = 'login') => {
                authSection.classList.remove('opacity-0', 'pointer-events-none');
                authSection.querySelector('#auth-modal').classList.remove('scale-95');
                if (view === 'login') {
                    loginView.classList.remove('hidden');
                    signupView.classList.add('hidden');
                } else {
                    loginView.classList.add('hidden');
                    signupView.classList.remove('hidden');
                }
            };

            const hideAuthModal = () => {
                authSection.classList.add('opacity-0');
                authSection.querySelector('#auth-modal').classList.add('scale-95');
                setTimeout(() => authSection.classList.add('pointer-events-none'), 300);
            };

            const showTutorialModal = () => {
                // Check if user has seen tutorial in this session
                if (!sessionStorage.getItem('tutorialSeen')) {
                    tutorialModalSection.classList.remove('opacity-0', 'pointer-events-none');
                    tutorialModalSection.querySelector('#tutorial-modal').classList.remove('scale-95');
                    sessionStorage.setItem('tutorialSeen', 'true');
                }
            };

            const hideTutorialModal = () => {
                tutorialModalSection.classList.add('opacity-0');
                tutorialModalSection.querySelector('#tutorial-modal').classList.add('scale-95');
                setTimeout(() => tutorialModalSection.classList.add('pointer-events-none'), 300);
            };

            const showDashboard = (user) => {
                landingPage.classList.add('hidden');
                dashboardSection.classList.remove('hidden');
                dashboardSection.classList.add('fade-in');

                if (!isDashboardInitialized) {
                    initializeDashboard(user);
                    isDashboardInitialized = true;
                    // Show Tutorial on first dashboard load
                    setTimeout(showTutorialModal, 1000);
                } else {
                    if (typeof loadDashboardData === 'function') loadDashboardData();
                }
            };

            const showLanding = () => {
                dashboardSection.classList.add('hidden');
                landingPage.classList.remove('hidden');
                landingPage.classList.add('fade-in');
            };

            const showLoadingState = (button, text) => {
                button.disabled = true;
                button.dataset.originalText = button.innerHTML;
                button.innerHTML = `<div class="spinner inline-block mr-2"></div>${text}`;
            };

            const hideLoadingState = (button) => {
                button.disabled = false;
                button.innerHTML = button.dataset.originalText;
            };

            const showMessage = (elementId, message, isError = true) => {
                const element = document.getElementById(elementId);
                element.textContent = message;
                element.classList.remove('hidden');
                if (isError) {
                    element.classList.remove('text-green-400', 'bg-green-900/50');
                    element.classList.add('text-red-400', 'bg-red-900/50');
                } else {
                    element.classList.remove('text-red-400', 'bg-red-900/50');
                    element.classList.add('text-green-400', 'bg-green-900/50');
                }
            };

            // --- Landing Event Listeners ---
            loginBtn.addEventListener('click', () => showAuthModal('login'));
            signupBtn.addEventListener('click', () => showAuthModal('signup'));
            closeAuthModalBtn.addEventListener('click', hideAuthModal);
            document.querySelectorAll('.close-auth-modal-btn').forEach(btn => btn.addEventListener('click', hideAuthModal));
            showSignupViewBtn.addEventListener('click', () => showAuthModal('signup'));
            showLoginViewBtn.addEventListener('click', () => showAuthModal('login'));

            // Tutorial Events
            closeTutorialModalBtn.addEventListener('click', hideTutorialModal);
            finishTutorialBtn.addEventListener('click', hideTutorialModal);

            // --- Auth Logic ---
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const btn = loginForm.querySelector('button[type="submit"]');

                showMessage('login-error-message', '', true);
                document.getElementById('login-error-message').classList.add('hidden');
                showLoadingState(btn, 'Ingresando...');

                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

                if (error) {
                    showMessage('login-error-message', 'Error: Credenciales incorrectas');
                    hideLoadingState(btn);
                } else {
                    hideAuthModal();
                    loginForm.reset();
                    hideLoadingState(btn);
                }
            });

            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                const confirmPassword = document.getElementById('signup-confirm-password').value;
                const terms = document.getElementById('terms').checked;
                const btn = signupForm.querySelector('button[type="submit"]');

                document.getElementById('signup-error-message').classList.add('hidden');
                document.getElementById('signup-success-message').classList.add('hidden');

                if (password !== confirmPassword) {
                    showMessage('signup-error-message', 'Las contrase침as no coinciden.');
                    return;
                }
                if (!terms) {
                    showMessage('signup-error-message', 'Debes aceptar los T칠rminos y Condiciones.');
                    return;
                }

                showLoadingState(btn, 'Creando cuenta...');
                const { data, error } = await supabaseClient.auth.signUp({ email, password });

                if (error) {
                    showMessage('signup-error-message', error.message);
                } else {
                    showMessage('signup-success-message', '춰Cuenta creada! Revisa tu email para confirmar.', false);
                    signupForm.reset();
                }
                hideLoadingState(btn);
            });

            // --- Session Monitor ---
            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                if (session) {
                    showDashboard(session.user);
                } else {
                    showLanding();
                    isDashboardInitialized = false;
                }
            });

            // --- Dashboard Logic ---
            const initializeDashboard = (user) => {
                // Elements
                const userEmailDisplay = document.getElementById('user-email-display');
                const logoutBtn = document.getElementById('logout-btn');
                const sidebar = document.getElementById('sidebar');
                const menuToggleBtn = document.getElementById('menu-toggle-btn');
                const sidebarLinks = document.querySelectorAll('.sidebar-link');
                const dashboardViews = document.querySelectorAll('.dashboard-view');

                // Pagination & History Elements
                const pageSizeSelect = document.getElementById('page-size-select');
                const prevPageBtn = document.getElementById('prev-page-btn');
                const nextPageBtn = document.getElementById('next-page-btn');
                const pageIndicator = document.getElementById('page-indicator');
                const usageHistoryBody = document.getElementById('usage-history-body');

                // Error Modal Elements
                const errorModalSection = document.getElementById('error-modal-section');
                const closeErrorModal = document.getElementById('close-error-modal');
                const errorContentModal = document.getElementById('error-analysis-content-modal');

                // Delete Account
                const deleteAccountBtn = document.getElementById('delete-account-btn');
                const deleteConfirmModalSection = document.getElementById('delete-confirm-modal-section');
                const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
                const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

                let currentPage = 0;
                let pageSize = parseInt(pageSizeSelect.value, 10) || 5;
                let totalRecords = 0;

                userEmailDisplay.textContent = user.email;
                document.getElementById('profile-email').value = user.email;

                // --- Helper Logic ---
                const showErrorModal = (errors) => {
                    errorContentModal.innerHTML = '';
                    if (!errors || errors.length === 0) {
                        errorContentModal.innerHTML = '<p>Error desconocido.</p>';
                    } else {
                        errors.forEach(err => {
                            const div = document.createElement('div');
                            div.className = 'bg-gray-900 p-3 rounded border border-dark';
                            div.innerHTML = `<strong class="text-amber-500">Fila ${err.linea || '?'}:</strong> ${err.error}`;
                            errorContentModal.appendChild(div);
                        });
                    }
                    errorModalSection.classList.remove('opacity-0', 'pointer-events-none');
                    errorModalSection.querySelector('#error-modal').classList.remove('scale-95');
                };

                const hideErrorModal = () => {
                    errorModalSection.classList.add('opacity-0');
                    errorModalSection.querySelector('#error-modal').classList.add('scale-95');
                    setTimeout(() => errorModalSection.classList.add('pointer-events-none'), 300);
                };

                // --- Api Proxy Handler ---
                const handleApiProxySubmit = async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const submitButton = form.querySelector('button[type="submit"]');

                    showLoadingState(submitButton, 'Emitiendo Boletas...');
                    const apiResponseArea = document.getElementById('api-response-area');
                    apiResponseArea.innerHTML = `<div class="flex items-center justify-center h-full text-green-400"><div class="spinner mr-2"></div>Conectando con SII...</div>`;

                    try {
                        const { data: { session } } = await supabaseClient.auth.getSession();
                        if (!session) throw new Error("Sesi칩n expirada");

                        const formData = new FormData(form);
                        const selectedApi = document.getElementById('api-select').value;
                        const proxyApiUrl = `https://boletapro-api-742039510932.southamerica-west1.run.app/${selectedApi}`;

                        const response = await fetch(proxyApiUrl, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${session.access_token}` },
                            body: formData
                        });

                        const contentType = response.headers.get("content-type");

                        if (!response.ok) {
                            const errorData = await response.json();
                            apiResponseArea.innerHTML = `<div class="text-red-400 font-mono text-xs p-2 whitespace-pre-wrap">${JSON.stringify(errorData, null, 2)}</div>`;
                        } else if (contentType && contentType.includes("application/zip")) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'boletas_emitidas.zip';
                            a.click();
                            window.URL.revokeObjectURL(url);
                            apiResponseArea.innerHTML = `<div class="text-green-400 text-center font-bold p-4">九 춰Proceso Exitoso!<br><span class="text-white font-normal text-sm">Tu archivo ZIP se ha descargado.</span></div>`;
                            loadUsageHistory();
                            loadDashboardData(); // Refresh consumption bars
                        } else {
                            const result = await response.json();
                            apiResponseArea.innerHTML = `<div class="text-green-400 font-mono text-xs p-2 whitespace-pre-wrap">${JSON.stringify(result, null, 2)}</div>`;
                            loadUsageHistory();
                            loadDashboardData();
                        }
                    } catch (error) {
                        apiResponseArea.innerHTML = `<div class="text-red-500 p-4">Error de conexi칩n: ${error.message}</div>`;
                    } finally {
                        hideLoadingState(submitButton);
                    }
                };

                // --- Render Functions ---
                const renderConsumption = (usageData, planLimit) => {
                    const container = document.getElementById('consumption-container');
                    const bheDisplay = document.getElementById('bhe-count-display');
                    container.innerHTML = '';

                    const safeUsage = usageData || { bht_usage: 0, bhe_usage: 0 };
                    const bheCount = safeUsage.bhe_usage || 0;
                    const bhtCount = safeUsage.bht_usage || 0;
                    const totalUsed = bheCount + bhtCount;
                    const limitDisplay = planLimit > 99999 ? 'Ilimitado' : planLimit;

                    // Update additional BHE card
                    if (bheDisplay) {
                        bheDisplay.textContent = bheCount;
                    }

                    // Total Bar
                    const percentage = planLimit > 0 ? Math.min(100, (totalUsed / planLimit) * 100) : 0;

                    const html = `
                        <div> 
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-bold text-white">Total Emitido</span>
                                <span class="text-sm text-primary-green">${totalUsed} / ${limitDisplay}</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-4">
                                <div class="bg-primary-green h-4 rounded-full transition-all duration-1000" style="width: ${percentage}%"></div>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">Renovaci칩n de cupo: 1 de cada mes.</p>
                        </div>
                    `;
                    container.innerHTML = html;
                };

                // --- RUT Validation & Formatting ---
                const formatAndValidateRUT = (input) => {
                    let rut = input.value.trim();
                    if (!rut) return { valid: false, formatted: '' };

                    // Limpiar puntos y guiones intermedios, mantener solo n칰meros y K
                    let clean = rut.replace(/[^0-9kK]/g, '');
                    if (clean.length < 2) return { valid: false, formatted: clean };

                    const cuerpo = clean.slice(0, -1);
                    const dv = clean.slice(-1).toUpperCase();

                    // Validar DV
                    let suma = 0;
                    let multiplo = 2;
                    for (let i = cuerpo.length - 1; i >= 0; i--) {
                        suma += parseInt(cuerpo.charAt(i)) * multiplo;
                        multiplo = multiplo < 7 ? multiplo + 1 : 2;
                    }
                    const dvEsperado = 11 - (suma % 11);
                    const dvCalculado = dvEsperado === 11 ? '0' : dvEsperado === 10 ? 'K' : dvEsperado.toString();

                    const isValid = dvCalculado === dv;
                    const formatted = `${cuerpo}-${dv}`;

                    if (isValid) {
                        input.value = formatted;
                        input.classList.remove('border-red-500');
                        input.classList.add('border-primary-green');
                    } else {
                        input.classList.remove('border-primary-green');
                        input.classList.add('border-red-500');
                    }

                    return { valid: isValid, formatted };
                };

                const renderHistory = (logs) => {
                    usageHistoryBody.innerHTML = '';
                    if (!logs || logs.length === 0) {
                        usageHistoryBody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-gray-500">No has realizado emisiones a칰n.</td></tr>`;
                        return;
                    }

                    logs.forEach(log => {
                        const tr = document.createElement('tr');
                        tr.className = 'border-b border-dark hover:bg-surface-dark transition';

                        const statusBadge = log.fue_exitoso
                            ? `<span class="px-2 py-1 text-xs font-semibold text-green-300 bg-green-900/50 rounded-full border border-green-800">Exitoso</span>`
                            : `<span class="px-2 py-1 text-xs font-semibold text-red-300 bg-red-900/50 rounded-full border border-red-800">Error</span>`;

                        const downloadLink = log.resultado_url
                            ? `<a href="${log.resultado_url}" target="_blank" class="text-primary-green hover:underline flex items-center gap-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> ZIP</a>`
                            : '<span class="text-gray-600">-</span>';

                        const errorBtn = (!log.fue_exitoso && log.detalles_error)
                            ? `<button class="text-amber-500 hover:text-amber-400 text-sm font-semibold error-btn">Ver Error</button>`
                            : '';

                        const displayId = log.task_id ? log.task_id : String(log.id).substring(0, 8);
                        const idTitle = log.task_id ? `Cloud Task ID: ${log.task_id}` : `ID Interno: ${log.id}`;

                        tr.innerHTML = `
                            <td class="p-4 font-mono text-xs text-gray-500" title="${idTitle}">${displayId}${log.task_id ? '' : '...'}</td>
                            <td class="p-4 text-sm">${new Date(log.fecha_registro).toLocaleDateString('es-CL')}</td>
                            <td class="p-4 text-sm font-semibold text-white">${log.servicio_api.toUpperCase()}</td>
                            <td class="p-4 text-sm">${log.cantidad_procesada}</td>
                            <td class="p-4">${statusBadge}</td>
                            <td class="p-4 text-sm">${downloadLink}</td>
                            <td class="p-4">${errorBtn}</td>
                        `;

                        // Attach error data to button
                        if (errorBtn) {
                            const btn = tr.querySelector('.error-btn');
                            btn.onclick = () => showErrorModal(log.detalles_error);
                        }

                        usageHistoryBody.appendChild(tr);
                    });

                    // Pagination state update
                    const totalPages = Math.ceil(totalRecords / pageSize);
                    pageIndicator.textContent = `P치gina ${currentPage + 1} de ${totalPages || 1}`;
                    prevPageBtn.disabled = currentPage === 0;
                    nextPageBtn.disabled = (currentPage + 1) * pageSize >= totalRecords;
                };

                const loadUsageHistory = async () => {
                    const from = currentPage * pageSize;
                    const to = from + pageSize - 1;

                    // Get Count
                    const { count } = await supabaseClient.from('registros_uso_api').select('*', { count: 'exact', head: true });
                    totalRecords = count || 0;

                    // Get Data
                    const { data, error } = await supabaseClient
                        .from('registros_uso_api')
                        .select('*')
                        .order('fecha_registro', { ascending: false })
                        .range(from, to);

                    if (!error) renderHistory(data);
                };

                loadDashboardData = async () => {
                    // 1. Get Plan & Profile
                    const { data: profile } = await supabaseClient.from('perfiles').select('plan_id, planes(nombre, limite_llamadas_api)').eq('usuario_id', user.id).single();

                    let planName = "Gratuito";
                    let planLimit = 20; // Default Free

                    if (profile && profile.planes) {
                        planName = profile.planes.nombre;
                        planLimit = profile.planes.limite_llamadas_api;
                    }

                    document.getElementById('current-plan-name').textContent = planName;

                    // 2. Get Consumption
                    const { data: usage } = await supabaseClient.rpc('get_monthly_consumption');
                    renderConsumption(usage, planLimit);

                    // 3. Load History
                    loadUsageHistory();
                };

                // --- Event Listeners Internal ---
                logoutBtn.onclick = () => supabaseClient.auth.signOut();
                menuToggleBtn.onclick = () => sidebar.classList.toggle('-translate-x-full');

                sidebarLinks.forEach(link => {
                    link.onclick = (e) => {
                        e.preventDefault();
                        sidebarLinks.forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                        dashboardViews.forEach(v => v.classList.add('hidden'));
                        document.getElementById(link.dataset.view).classList.remove('hidden');
                        if (window.innerWidth < 1024) sidebar.classList.add('-translate-x-full');
                    };
                });

                // Pagination
                prevPageBtn.onclick = () => { if (currentPage > 0) { currentPage--; loadUsageHistory(); } };
                nextPageBtn.onclick = () => { if ((currentPage + 1) * pageSize < totalRecords) { currentPage++; loadUsageHistory(); } };
                pageSizeSelect.onchange = (e) => { pageSize = parseInt(e.target.value); currentPage = 0; loadUsageHistory(); };

                // Modals
                closeErrorModal.onclick = hideErrorModal;
                deleteAccountBtn.onclick = () => {
                    deleteConfirmModalSection.classList.remove('opacity-0', 'pointer-events-none');
                    deleteConfirmModalSection.querySelector('div').classList.remove('scale-95');
                };
                cancelDeleteBtn.onclick = () => {
                    deleteConfirmModalSection.classList.add('opacity-0');
                    setTimeout(() => deleteConfirmModalSection.classList.add('pointer-events-none'), 300);
                };
                confirmDeleteBtn.onclick = async () => {
                    // Logic to delete account via Supabase Edge Function or similar would go here
                    alert("Funcionalidad de borrado contactando soporte.");
                    // Usually users can't delete their own auth record directly without backend function
                };

                // ============================================
                // WIZARD LOGIC - Emisi칩n de Boletas (4 Pasos)
                // ============================================

                // Wizard State
                let currentWizardStep = 1;
                let selectedTipoBoleta = null;
                let uploadedFile = null;
                let excelData = null;
                let validationErrors = [];

                // Wizard Elements
                const wizardSteps = document.querySelectorAll('.wizard-step');
                const wizardContents = [
                    document.getElementById('wizard-step-1'),
                    document.getElementById('wizard-step-2'),
                    document.getElementById('wizard-step-3'),
                    document.getElementById('wizard-step-4')
                ];

                // Step 1 Elements
                const radioCards = document.querySelectorAll('.radio-card');
                const tipoBheRadio = document.getElementById('tipo-bhe');
                const tipoBhetRadio = document.getElementById('tipo-bhet');
                const btnStep1Next = document.getElementById('btn-step1-next');

                // Step 2 Elements
                const dropZone = document.getElementById('drop-zone');
                const fileInput = document.getElementById('file-input');
                const fileInfo = document.getElementById('file-info');
                const fileName = document.getElementById('file-name');
                const fileSize = document.getElementById('file-size');
                const btnRemoveFile = document.getElementById('btn-remove-file');
                const plantillaBheInfo = document.getElementById('plantilla-bhe-info');
                const btnStep2Back = document.getElementById('btn-step2-back');
                const btnStep2Next = document.getElementById('btn-step2-next');

                // Step 3 Elements
                const validationStatus = document.getElementById('validation-status');
                const previewTable = document.getElementById('preview-table');
                const btnStep3Back = document.getElementById('btn-step3-back');
                const btnStep3Next = document.getElementById('btn-step3-next');

                // Step 4 Elements
                const wizardFinalForm = document.getElementById('wizard-final-form');
                const wizardTipoRetencionContainer = document.getElementById('wizard-tipo-retencion-container');
                const btnStep4Back = document.getElementById('btn-step4-back');
                const btnEmitNow = document.getElementById('btn-emit-now');
                const emissionResult = document.getElementById('emission-result');

                // Utility Functions
                const showToast = (message, type = 'success') => {
                    const toast = document.createElement('div');
                    toast.className = `toast ${type}`;
                    toast.textContent = message;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                };

                const formatFileSize = (bytes) => {
                    if (bytes < 1024) return bytes + ' B';
                    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
                };

                const updateWizardUI = (step) => {
                    // Update stepper
                    wizardSteps.forEach((ws, index) => {
                        const stepNum = index + 1;
                        ws.classList.remove('active', 'completed');
                        if (stepNum < step) ws.classList.add('completed');
                        if (stepNum === step) ws.classList.add('active');
                    });

                    // Update content
                    wizardContents.forEach((content, index) => {
                        content.classList.toggle('hidden', index + 1 !== step);
                    });

                    currentWizardStep = step;
                };

                // ===== STEP 1: Tipo de Boleta =====
                const handleTipoBoletaChange = () => {
                    const selected = document.querySelector('input[name="tipo-boleta"]:checked');
                    selectedTipoBoleta = selected ? selected.value : null;

                    // Update radio card styles
                    radioCards.forEach(card => {
                        const input = card.querySelector('input[type="radio"]');
                        card.classList.toggle('selected', input.checked);
                    });

                    // Enable/disable next button
                    if (selectedTipoBoleta) {
                        btnStep1Next.disabled = false;
                        btnStep1Next.classList.remove('bg-gray-600', 'cursor-not-allowed');
                        btnStep1Next.classList.add('bg-primary-green', 'bg-primary-green-hover');
                    }
                };

                tipoBheRadio.addEventListener('change', handleTipoBoletaChange);
                tipoBhetRadio.addEventListener('change', handleTipoBoletaChange);

                btnStep1Next.addEventListener('click', () => {
                    if (selectedTipoBoleta) {
                        // Show plantilla info only for BHE
                        plantillaBheInfo.classList.toggle('hidden', selectedTipoBoleta !== 'bhe');
                        updateWizardUI(2);
                    }
                });

                // ===== STEP 2: Carga de Archivo =====
                const handleFileSelect = (file) => {
                    // Validate file type
                    const validExtensions = ['.csv', '.xlsx', '.xls'];
                    const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

                    if (!validExtensions.includes(fileExtension)) {
                        showToast('Formato de archivo no v치lido. Usa .csv o .xlsx', 'error');
                        return;
                    }

                    // Validate file size (5MB max)
                    const maxSize = 5 * 1024 * 1024;
                    if (file.size > maxSize) {
                        showToast('El archivo excede el l칤mite de 5MB', 'error');
                        return;
                    }

                    uploadedFile = file;

                    // Show file info
                    fileName.textContent = file.name;
                    fileSize.textContent = formatFileSize(file.size);
                    fileInfo.classList.remove('hidden');
                    dropZone.classList.add('hidden');

                    // Enable next button
                    btnStep2Next.disabled = false;
                    btnStep2Next.classList.remove('bg-gray-600', 'cursor-not-allowed');
                    btnStep2Next.classList.add('bg-primary-green', 'bg-primary-green-hover');
                };

                // Drag & Drop handlers
                dropZone.addEventListener('click', () => fileInput.click());

                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('drag-over');
                });

                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('drag-over');
                });

                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('drag-over');
                    const file = e.dataTransfer.files[0];
                    if (file) handleFileSelect(file);
                });

                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) handleFileSelect(file);
                });

                btnRemoveFile.addEventListener('click', () => {
                    uploadedFile = null;
                    excelData = null;
                    fileInput.value = '';
                    fileInfo.classList.add('hidden');
                    dropZone.classList.remove('hidden');
                    btnStep2Next.disabled = true;
                    btnStep2Next.classList.add('bg-gray-600', 'cursor-not-allowed');
                    btnStep2Next.classList.remove('bg-primary-green', 'bg-primary-green-hover');
                });

                btnStep2Back.addEventListener('click', () => updateWizardUI(1));

                btnStep2Next.addEventListener('click', async () => {
                    if (!uploadedFile) return;

                    // Read Excel file
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            excelData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                            if (excelData.length === 0) {
                                showToast('El archivo est치 vac칤o', 'error');
                                return;
                            }

                            // Render preview and validate
                            renderPreview();
                            validateData();
                            updateWizardUI(3);
                        } catch (error) {
                            showToast('Error al leer el archivo: ' + error.message, 'error');
                        }
                    };
                    reader.readAsArrayBuffer(uploadedFile);
                });

                // ===== STEP 3: Previsualizaci칩n y Validaci칩n =====
                const renderPreview = () => {
                    if (!excelData || excelData.length === 0) return;

                    const headers = excelData[0];
                    const rows = excelData.slice(1, 6); // First 5 rows

                    // Render headers
                    const thead = previewTable.querySelector('thead');
                    thead.innerHTML = '<tr>' + headers.map(h => `<th class="p-3 text-left font-semibold text-gray-400">${h || ''}</th>`).join('') + '</tr>';

                    // Render rows
                    const tbody = previewTable.querySelector('tbody');
                    tbody.innerHTML = rows.map(row =>
                        '<tr class="border-b border-dark">' +
                        headers.map((_, i) => `<td class="p-3">${row[i] !== undefined ? row[i] : ''}</td>`).join('') +
                        '</tr>'
                    ).join('');
                };

                const validateData = () => {
                    validationErrors = [];

                    if (selectedTipoBoleta === 'bhe') {
                        // Validaci칩n para BHE
                        validationErrors = validateBHE(excelData);
                    } else {
                        // Para BHT, validaci칩n b치sica (el servidor hace la validaci칩n completa)
                        if (excelData.length < 2) {
                            validationErrors.push({ linea: 0, error: 'El archivo debe contener al menos una fila de datos' });
                        }
                    }

                    // Render validation status
                    if (validationErrors.length === 0) {
                        validationStatus.innerHTML = `
                            <div class="p-4 bg-green-900/20 border border-green-800 rounded-lg flex items-center gap-3">
                                <svg class="w-6 h-6 text-primary-green flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div>
                                    <p class="font-semibold text-primary-green">九 Validaci칩n Exitosa</p>
                                    <p class="text-sm text-gray-400">Todos los datos son correctos. Puedes continuar.</p>
                                </div>
                            </div>
                        `;
                        validationStatus.classList.remove('hidden');
                        btnStep3Next.disabled = false;
                        btnStep3Next.classList.remove('bg-gray-600', 'cursor-not-allowed');
                        btnStep3Next.classList.add('bg-primary-green', 'bg-primary-green-hover');
                    } else {
                        validationStatus.innerHTML = `
                            <div class="p-4 bg-red-900/20 border border-red-800 rounded-lg">
                                <div class="flex items-center gap-3 mb-3">
                                    <svg class="w-6 h-6 text-red-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div>
                                        <p class="font-semibold text-red-400">九 Errores Encontrados</p>
                                        <p class="text-sm text-gray-400">Corrige los siguientes errores antes de continuar:</p>
                                    </div>
                                </div>
                                <div class="space-y-2 max-h-60 overflow-y-auto">
                                    ${validationErrors.map(err => `
                                        <div class="bg-gray-900 p-2 rounded text-sm">
                                            <span class="text-amber-500 font-semibold">Fila ${err.linea}:</span>
                                            <span class="text-gray-300"> ${err.error}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                        validationStatus.classList.remove('hidden');
                        btnStep3Next.disabled = true;
                        btnStep3Next.classList.add('bg-gray-600', 'cursor-not-allowed');
                        btnStep3Next.classList.remove('bg-primary-green', 'bg-primary-green-hover');
                    }
                };

                // Validaci칩n BHE (Mejorada con Mapeo de Columnas)
                const validateBHE = (data) => {
                    const errors = [];
                    let headers = data[0].map(h => String(h).trim()); // Headers originales limpios
                    const rows = data.slice(1);

                    // Mapa de alias aceptados para cada columna est치ndar
                    const columnMapping = {
                        'RUT Receptor': ['rut', 'rut receptor', 'rut_receptor', 'rut_completo_destinatario', 'rut destinatario'],
                        'Raz칩n Social': ['raz칩n social', 'razon social', 'nombre', 'nombres', 'txt_nombres_destinatario', 'nombre destinatario', 'razon_social'],
                        'Direcci칩n': ['direcci칩n', 'direccion', 'domicilio', 'txt_domicilio_destinatario', 'calle'],
                        'Comuna': ['comuna', 'txt_comuna_destinatario', 'ciudad'],
                        'Fecha Emisi칩n': ['fecha', 'fecha emisi칩n', 'fecha emision', 'fecha_boleta', 'fecha boleta'],
                        'Monto Honorarios': ['monto', 'monto honorarios', 'valor', 'valor_prestacion_1', 'valor prestacion', 'honorarios'],
                        'Descripci칩n': ['descripci칩n', 'descripcion', 'detalle', 'glosa', 'desc_prestacion_1', 'prestacion']
                    };

                    // Normalizar headers
                    const normalizedHeaders = headers.map(header => {
                        const headerLower = header.toLowerCase();
                        for (const [standardName, aliases] of Object.entries(columnMapping)) {
                            if (standardName.toLowerCase() === headerLower || aliases.includes(headerLower)) {
                                return standardName;
                            }
                        }
                        return header; // Si no coincide, dejar original
                    });

                    // Reemplazar headers en la data original (para referencia posterior si fuera necesario)
                    data[0] = normalizedHeaders;
                    headers = normalizedHeaders;

                    // Verificar columnas requeridas
                    const requiredColumns = ['RUT Receptor', 'Raz칩n Social', 'Direcci칩n', 'Comuna', 'Fecha Emisi칩n', 'Monto Honorarios', 'Descripci칩n'];
                    const missingColumns = requiredColumns.filter(col => !headers.includes(col));

                    if (missingColumns.length > 0) {
                        errors.push({ linea: 0, error: `Faltan columnas requeridas o no se reconocen: ${missingColumns.join(', ')}` });
                        return errors;
                    }

                    // Validar cada fila
                    rows.forEach((row, index) => {
                        const lineNum = index + 2;

                        // Ignorar filas completamente vac칤as
                        const isEmptyRow = !row || row.length === 0 || row.every(cell => cell === undefined || cell === null || String(cell).trim() === '');
                        if (isEmptyRow) return;

                        // Crear objeto de la fila usando headers normalizados
                        const rowData = {};
                        headers.forEach((header, i) => {
                            rowData[header] = row[i];
                        });

                        // Validar RUT
                        const rut = rowData['RUT Receptor'];
                        if (!rut || !validateRUT(String(rut))) {
                            errors.push({ linea: lineNum, error: `RUT Receptor inv치lido (${rut || 'vac칤o'})` });
                        }

                        // Validar Raz칩n Social
                        if (!rowData['Raz칩n Social'] || String(rowData['Raz칩n Social']).trim() === '') {
                            errors.push({ linea: lineNum, error: 'Raz칩n Social es requerida' });
                        }

                        // Validar Fecha
                        const fecha = rowData['Fecha Emisi칩n'];
                        if (!fecha || !validateFecha(fecha)) {
                            errors.push({ linea: lineNum, error: `Fecha Emisi칩n inv치lida (${fecha}). Formato: DD-MM-YYYY` });
                        }

                        // Validar Monto
                        const monto = rowData['Monto Honorarios'];
                        if (!monto || isNaN(Number(monto)) || Number(monto) <= 0) {
                            errors.push({ linea: lineNum, error: 'Monto Honorarios debe ser un n칰mero positivo' });
                        }

                        // Validar Descripci칩n
                        if (!rowData['Descripci칩n'] || String(rowData['Descripci칩n']).trim() === '') {
                            errors.push({ linea: lineNum, error: 'Descripci칩n es requerida' });
                        }
                    });

                    return errors;
                };

                // Validar RUT chileno
                const validateRUT = (rut) => {
                    if (!rut) return false;

                    // Limpiar RUT
                    const cleanRut = rut.replace(/[.-]/g, '');
                    if (cleanRut.length < 2) return false;

                    const body = cleanRut.slice(0, -1);
                    const dv = cleanRut.slice(-1).toUpperCase();

                    // Calcular d칤gito verificador
                    let sum = 0;
                    let multiplier = 2;

                    for (let i = body.length - 1; i >= 0; i--) {
                        sum += parseInt(body[i]) * multiplier;
                        multiplier = multiplier === 7 ? 2 : multiplier + 1;
                    }

                    const expectedDV = 11 - (sum % 11);
                    const calculatedDV = expectedDV === 11 ? '0' : expectedDV === 10 ? 'K' : String(expectedDV);

                    return dv === calculatedDV;
                };

                // Validar fecha DD-MM-YYYY
                const validateFecha = (fecha) => {
                    if (!fecha) return false;

                    // Si es un n칰mero de Excel, convertirlo
                    if (typeof fecha === 'number') {
                        const excelEpoch = new Date(1899, 11, 30);
                        const date = new Date(excelEpoch.getTime() + fecha * 86400000);
                        const day = String(date.getDate()).padStart(2, '0');
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const year = date.getFullYear();
                        fecha = `${day}-${month}-${year}`;
                    }

                    const regex = /^(\d{2})-(\d{2})-(\d{4})$/;
                    const match = String(fecha).match(regex);

                    if (!match) return false;

                    const day = parseInt(match[1]);
                    const month = parseInt(match[2]);
                    const year = parseInt(match[3]);

                    if (month < 1 || month > 12) return false;
                    if (day < 1 || day > 31) return false;
                    if (year < 2000 || year > 2100) return false;

                    return true;
                };

                btnStep3Back.addEventListener('click', () => updateWizardUI(2));

                btnStep3Next.addEventListener('click', () => {
                    if (validationErrors.length === 0) {
                        // Show tipo_retencion only for BHE
                        wizardTipoRetencionContainer.classList.toggle('hidden', selectedTipoBoleta !== 'bhe');
                        updateWizardUI(4);
                    }
                });

                // ===== STEP 4: Emisi칩n Final =====
                btnStep4Back.addEventListener('click', () => updateWizardUI(3));

                const wizardRutInput = document.getElementById('wizard-rut');

                // RUT auto-formatting on blur
                wizardRutInput.addEventListener('blur', () => {
                    formatAndValidateRUT(wizardRutInput);
                });

                wizardFinalForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    try {
                        const { data: { session } } = await supabaseClient.auth.getSession();
                        if (!session) throw new Error("Sesi칩n expirada");

                        // Double check RUT before emit
                        const rutValidation = formatAndValidateRUT(wizardRutInput);
                        if (!rutValidation.valid) {
                            showToast('El RUT ingresado no es v치lido', 'error');
                            return;
                        }

                        const cleanRut = rutValidation.formatted;
                        const clave = document.getElementById('wizard-clave').value;
                        const tipoRetencion = selectedTipoBoleta === 'bhe' ? document.getElementById('wizard-tipo-retencion').value : null;

                        // Show loading state
                        showLoadingState(btnEmitNow, 'Procesando...');
                        emissionResult.classList.add('hidden');

                        // Prepare FormData
                        const formData = new FormData();
                        formData.append('rut', cleanRut);
                        formData.append('clave', clave);
                        formData.append('csv_file', uploadedFile);
                        if (tipoRetencion) formData.append('tipo_retencion', tipoRetencion);

                        const proxyApiUrl = `https://boletapro-api-742039510932.southamerica-west1.run.app/${selectedTipoBoleta}/emitir-csv`;

                        const response = await fetch(proxyApiUrl, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${session.access_token}` },
                            body: formData
                        });

                        const contentType = response.headers.get("content-type");

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || 'Error en la emisi칩n');
                        } else if (contentType && contentType.includes("application/zip")) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'boletas_emitidas.zip';
                            a.click();
                            window.URL.revokeObjectURL(url);

                            emissionResult.innerHTML = `
                                <div class="text-center">
                                    <svg class="w-16 h-16 mx-auto mb-4 text-primary-green" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <h4 class="text-2xl font-bold text-primary-green mb-2">춰Emisi칩n Exitosa!</h4>
                                    <p class="text-gray-400">Tu archivo ZIP se ha descargado autom치ticamente.</p>
                                </div>
                            `;
                            emissionResult.classList.remove('hidden', 'border-red-800', 'bg-red-900/20');
                            emissionResult.classList.add('border-green-800', 'bg-green-900/20');

                            showToast('춰Boletas emitidas exitosamente!', 'success');
                            loadUsageHistory();
                            loadDashboardData();
                        } else {
                            const result = await response.json();
                            const taskId = result.task_id ? result.task_id.split('/').pop() : 'N/A';

                            showToast('춰Proceso iniciado!', 'success');

                            emissionResult.innerHTML = `
                                <div class="text-center p-4">
                                    <div class="w-16 h-16 bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-4 border border-blue-500">
                                        <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                        </svg>
                                    </div>
                                    <h4 class="text-xl font-bold text-white mb-2">춰Solicitud Recibida!</h4>
                                    <p class="text-sm text-gray-400 mb-6">${result.mensaje || 'Tu proceso se est치 ejecutando en segundo plano.'}</p>
                                    
                                    <div class="bg-gray-900 border border-dark rounded-lg p-3 text-left">
                                        <p class="text-[10px] uppercase tracking-wider text-gray-500 mb-1 font-bold">ID de Seguimiento (Cloud Task)</p>
                                        <div class="flex items-center justify-between gap-2">
                                            <code class="text-xs text-primary-green break-all">${taskId}</code>
                                            <button onclick="navigator.clipboard.writeText('${taskId}'); showToast('ID Copiado', 'success')" 
                                                    class="p-2 hover:bg-gray-800 rounded-md transition-colors text-gray-400 hover:text-white" title="Copiar ID">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-4 leading-relaxed">
                                        Puedes cerrar esta ventana. El proceso continuar치 autom치ticamente y aparecer치 en tu historial cuando termine.
                                    </p>
                                </div>
                            `;
                            emissionResult.classList.remove('hidden', 'border-red-800', 'bg-red-900/20');
                            emissionResult.classList.add('border-blue-800', 'bg-blue-900/10');
                        }
                    } catch (error) {
                        let errorMessage = error.message;

                        // Intentar extraer detalle estructurado si es un error del servidor (p.ej. 402)
                        const detailMsg = error.detail?.mensaje || error.detail?.detalle || error.detail;
                        if (detailMsg) errorMessage = detailMsg;

                        emissionResult.innerHTML = `
                            <div class="text-center p-4">
                                <svg class="w-16 h-16 mx-auto mb-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <h4 class="text-2xl font-bold text-red-400 mb-2">Error en la Emisi칩n</h4>
                                <p class="text-gray-300 bg-red-900/10 p-3 rounded border border-red-900/30 text-sm leading-relaxed">${errorMessage}</p>
                            </div>
                        `;
                        emissionResult.classList.remove('hidden', 'border-green-800', 'bg-green-900/20');
                        emissionResult.classList.add('border-red-800', 'bg-red-900/20');
                        showToast('Error: ' + errorMessage, 'error');
                    } finally {
                        hideLoadingState(btnEmitNow);
                    }
                });

                // ============================================
                // END WIZARD LOGIC
                // ============================================


                // Init
                loadDashboardData();
            };

        });
    </script>
</body>

</html>